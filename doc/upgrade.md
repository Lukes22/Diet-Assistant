# 饮食助手社交功能升级计划

## 一、功能需求概述

### 1.1 用户系统
- 注册：用户名、密码、性别、身高、体重、目标（减重/增肌/保持规律饮食）
- 登录：用户名 + 密码
- 设置：修改身高、体重、目标

### 1.2 饮食记录
- 保存每次饮食分析结果
- 展示一周饮食记录
- 支持删除和修改记录

### 1.3 好友系统
- 每个用户有唯一邀请码
- 通过邀请码添加好友
- 查看好友一周饮食记录
- 给好友留言

### 1.4 页面布局
- 左侧：原饮食助手对话界面
- 右上：一周饮食记录
- 右下：好友留言板
- 右上角：设置 + 好友入口

---

## 二、数据库设计

### 2.1 用户表 (users)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| username | VARCHAR(50) | 用户名，唯一 |
| password_hash | VARCHAR(128) | 密码哈希 |
| gender | VARCHAR(10) | 性别：male/female |
| height | FLOAT | 身高(cm) |
| weight | FLOAT | 体重(kg) |
| goal | VARCHAR(20) | 目标：lose_weight/gain_muscle/maintain |
| invite_code | VARCHAR(8) | 邀请码，唯一 |
| created_at | DATETIME | 注册时间 |

### 2.2 饮食记录表 (meal_records)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| user_id | INTEGER | 用户ID，外键 |
| meal_type | VARCHAR(10) | 餐次：早餐/午餐/晚餐/零食 |
| foods | TEXT | 食物列表JSON |
| total_calories | INTEGER | 总卡路里 |
| health_score | INTEGER | 健康评分 |
| dietary_advice | TEXT | 饮食建议 |
| created_at | DATETIME | 记录时间 |

### 2.3 好友关系表 (friendships)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| user_id | INTEGER | 用户ID |
| friend_id | INTEGER | 好友ID |
| created_at | DATETIME | 添加时间 |

### 2.4 留言表 (messages)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| from_user_id | INTEGER | 留言者ID |
| to_user_id | INTEGER | 接收者ID |
| content | TEXT | 留言内容 |
| created_at | DATETIME | 留言时间 |

---

## 三、后端 API 设计

### 3.1 用户认证 API

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/register | POST | 用户注册 |
| /api/login | POST | 用户登录 |
| /api/logout | POST | 退出登录 |
| /api/profile | GET | 获取用户信息 |
| /api/profile | PUT | 更新用户信息 |

### 3.2 饮食记录 API

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/meals | GET | 获取一周饮食记录 |
| /api/meals | POST | 保存饮食记录 |
| /api/meals/{id} | PUT | 修改饮食记录 |
| /api/meals/{id} | DELETE | 删除饮食记录 |

### 3.3 好友 API

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/friends | GET | 获取好友列表 |
| /api/friends | POST | 通过邀请码添加好友 |
| /api/friends/{id}/meals | GET | 查看好友一周饮食 |

### 3.4 留言 API

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/messages | GET | 获取收到的留言 |
| /api/messages | POST | 给好友留言 |

---

## 四、前端页面设计

### 4.1 页面结构

```
┌─────────────────────────────────────────────────────────────┐
│  饮食助手                              [设置] [好友]        │
├────────────────────────┬────────────────────────────────────┤
│                        │  一周饮食记录                      │
│                        │  ┌──────────────────────────────┐  │
│   饮食助手对话区域     │  │ 周一 早餐 500卡  [删除]      │  │
│                        │  │ 周一 午餐 800卡  [删除]      │  │
│   [早餐][午餐]         │  │ ...                          │  │
│   [晚餐][零食]         │  └──────────────────────────────┘  │
│                        ├────────────────────────────────────┤
│   输入框 [发送]        │  好友留言                          │
│                        │  ┌──────────────────────────────┐  │
│                        │  │ 小明: 今天吃的不错！         │  │
│                        │  │ 小红: 加油减肥！             │  │
│                        │  └──────────────────────────────┘  │
└────────────────────────┴────────────────────────────────────┘
```

### 4.2 新增页面

1. **登录/注册页面** (auth.html)
   - 登录表单：用户名、密码
   - 注册表单：用户名、密码、性别、身高、体重、目标
   - 切换登录/注册模式

2. **设置弹窗**
   - 显示当前身高、体重、目标
   - 支持修改并保存

3. **好友弹窗**
   - 显示自己的邀请码
   - 输入框：输入好友邀请码添加
   - 好友列表：点击进入好友详情

4. **好友详情弹窗**
   - 好友一周饮食记录
   - 留言输入框

---

## 五、文件修改清单

### 5.1 后端文件

| 文件 | 操作 | 说明 |
|------|------|------|
| app.py | 修改 | 添加用户认证、饮食记录、好友、留言 API |
| models.py | 新增 | 数据库模型定义 |
| requirements.txt | 修改 | 添加 flask-login, flask-sqlalchemy |

### 5.2 前端文件

| 文件 | 操作 | 说明 |
|------|------|------|
| templates/index.html | 修改 | 调整布局，添加右侧区域 |
| templates/auth.html | 新增 | 登录/注册页面 |
| static/css/style.css | 修改 | 新布局样式 |
| static/js/app.js | 修改 | 添加认证、记录、好友逻辑 |

### 5.3 数据库文件

| 文件 | 操作 | 说明 |
|------|------|------|
| database.db | 新增 | SQLite 数据库文件（自动生成）|

---

## 六、实现步骤

### 阶段一：用户系统（基础）
1. 创建数据库模型 (models.py)
2. 实现注册/登录 API
3. 创建登录/注册页面
4. 添加会话管理

### 阶段二：饮食记录
1. 实现饮食记录保存 API
2. 修改前端，分析完成后自动保存
3. 实现一周记录查询 API
4. 前端展示一周记录列表
5. 实现删除/修改功能

### 阶段三：好友系统
1. 生成用户邀请码逻辑
2. 实现添加好友 API
3. 实现好友列表 API
4. 前端好友弹窗
5. 查看好友饮食记录

### 阶段四：留言系统
1. 实现留言 API
2. 前端留言板展示
3. 给好友留言功能

### 阶段五：界面整合
1. 调整主页面布局（左右分栏）
2. 添加设置弹窗
3. 整体样式优化
4. 测试与调试

---

## 七、技术要点

### 7.1 密码安全
- 使用 werkzeug.security 进行密码哈希
- 不存储明文密码

### 7.2 会话管理
- 使用 Flask-Login 管理用户会话
- 支持记住登录状态

### 7.3 邀请码生成
- 8位随机字母数字组合
- 确保唯一性

### 7.4 数据库
- 使用 SQLite（轻量，无需额外服务）
- Flask-SQLAlchemy ORM

---

## 八、依赖更新

```txt
flask>=2.0
flask-cors
flask-login
flask-sqlalchemy
openai>=1.0
python-dotenv
werkzeug
```
