<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹ - é¥®é£ŸåŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="page-body">
    <div class="page-container">
        <header class="page-header">
            <a href="/" class="back-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                è¿”å›
            </a>
            <h1>å¥½å‹</h1>
        </header>

        <div class="page-content">
            <!-- æ·»åŠ å¥½å‹ -->
            <div class="friends-card">
                <h3>æ·»åŠ å¥½å‹</h3>
                <div class="add-friend-form">
                    <input type="text" id="inviteCodeInput" placeholder="è¾“å…¥å¥½å‹é‚€è¯·ç ">
                    <button onclick="addFriend()">æ·»åŠ </button>
                </div>
                <div class="error-message" id="addError"></div>
            </div>

            <!-- å¥½å‹åˆ—è¡¨ -->
            <div class="friends-card">
                <h3>å¥½å‹åˆ—è¡¨</h3>
                <div class="friends-list" id="friendsList">
                    <div class="empty-tip">æš‚æ— å¥½å‹</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¥½å‹è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="friendDetailModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="friendName">å¥½å‹è¯¦æƒ…</h2>
                <button class="close-btn" onclick="closeFriendDetail()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="friend-info-card">
                    <p><span>ç›®æ ‡:</span> <span id="friendGoal">-</span></p>
                </div>
                
                <div class="friend-meals-section">
                    <h4>ä¸€å‘¨é¥®é£Ÿè®°å½•</h4>
                    <div class="friend-meals-list" id="friendMealsList">
                        <div class="empty-tip">æš‚æ— è®°å½•</div>
                    </div>
                </div>
                
                <div class="leave-message-section">
                    <h4>ç»™TAç•™è¨€</h4>
                    <div class="message-input-group">
                        <input type="text" id="messageContent" placeholder="è¾“å…¥ç•™è¨€å†…å®¹ï¼ˆæœ€å¤š200å­—ï¼‰" maxlength="200">
                        <button onclick="sendMessage()">å‘é€</button>
                    </div>
                </div>
                
                <div class="chat-history-section">
                    <h4>ç•™è¨€è®°å½•</h4>
                    <div class="chat-history" id="chatHistory">
                        <div class="empty-tip">æš‚æ— ç•™è¨€</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFriendId = null;
        let currentUserId = null;

        // åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/profile');
                if (response.ok) {
                    const user = await response.json();
                    currentUserId = user.id;
                } else {
                    window.location.href = '/auth';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½å¥½å‹åˆ—è¡¨
        async function loadFriends() {
            try {
                const response = await fetch('/api/friends');
                if (response.ok) {
                    const friends = await response.json();
                    renderFriends(friends);
                }
            } catch (error) {
                console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å¥½å‹åˆ—è¡¨
        function renderFriends(friends) {
            const list = document.getElementById('friendsList');
            
            if (friends.length === 0) {
                list.innerHTML = '<div class="empty-tip">æš‚æ— å¥½å‹ï¼Œè¾“å…¥é‚€è¯·ç æ·»åŠ å¥½å‹å§</div>';
                return;
            }
            
            const goalMap = {
                'lose_weight': 'å‡é‡',
                'gain_muscle': 'å¢è‚Œ',
                'maintain': 'ä¿æŒè§„å¾‹é¥®é£Ÿ'
            };
            
            list.innerHTML = friends.map(friend => `
                <div class="friend-item" onclick="openFriendDetail(${friend.id}, '${escapeHtml(friend.username)}', '${friend.goal || ''}')">
                    <div class="friend-avatar">${friend.username.charAt(0).toUpperCase()}</div>
                    <div class="friend-info">
                        <div class="friend-name">${escapeHtml(friend.username)}</div>
                        <div class="friend-goal">${goalMap[friend.goal] || 'æœªè®¾ç½®ç›®æ ‡'}</div>
                    </div>
                    <svg class="arrow-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </div>
            `).join('');
        }

        // æ·»åŠ å¥½å‹
        async function addFriend() {
            const input = document.getElementById('inviteCodeInput');
            const code = input.value.trim();
            const errorEl = document.getElementById('addError');
            
            if (!code) {
                errorEl.textContent = 'è¯·è¾“å…¥é‚€è¯·ç ';
                return;
            }
            
            try {
                const response = await fetch('/api/friends', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invite_code: code })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    input.value = '';
                    errorEl.textContent = '';
                    alert('æ·»åŠ å¥½å‹æˆåŠŸï¼');
                    loadFriends();
                } else {
                    errorEl.textContent = result.error || 'æ·»åŠ å¤±è´¥';
                }
            } catch (error) {
                console.error('æ·»åŠ å¥½å‹å¤±è´¥:', error);
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            }
        }

        // æ‰“å¼€å¥½å‹è¯¦æƒ…
        async function openFriendDetail(friendId, friendName, friendGoal) {
            currentFriendId = friendId;
            
            const goalMap = {
                'lose_weight': 'å‡é‡',
                'gain_muscle': 'å¢è‚Œ',
                'maintain': 'ä¿æŒè§„å¾‹é¥®é£Ÿ'
            };
            
            document.getElementById('friendName').textContent = friendName;
            document.getElementById('friendGoal').textContent = goalMap[friendGoal] || 'æœªè®¾ç½®ç›®æ ‡';
            document.getElementById('friendDetailModal').classList.add('active');
            
            // åŠ è½½å¥½å‹é¥®é£Ÿè®°å½•
            await loadFriendMeals(friendId);
            
            // åŠ è½½èŠå¤©è®°å½•
            await loadChatHistory(friendId);
        }

        // å…³é—­å¥½å‹è¯¦æƒ…
        function closeFriendDetail() {
            document.getElementById('friendDetailModal').classList.remove('active');
            currentFriendId = null;
        }

        // åŠ è½½å¥½å‹é¥®é£Ÿè®°å½•
        async function loadFriendMeals(friendId) {
            try {
                const response = await fetch(`/api/friends/${friendId}/meals`);
                if (response.ok) {
                    const meals = await response.json();
                    renderFriendMeals(meals);
                }
            } catch (error) {
                console.error('åŠ è½½å¥½å‹é¥®é£Ÿè®°å½•å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å¥½å‹é¥®é£Ÿè®°å½•
        function renderFriendMeals(meals) {
            const list = document.getElementById('friendMealsList');
            
            if (meals.length === 0) {
                list.innerHTML = '<div class="empty-tip">æš‚æ— è®°å½•</div>';
                return;
            }
            
            const mealIcons = {
                'æ—©é¤': 'ğŸŒ…',
                'åˆé¤': 'â˜€ï¸',
                'æ™šé¤': 'ğŸŒ™',
                'é›¶é£Ÿ': 'ğŸª'
            };
            
            list.innerHTML = meals.map(meal => {
                const icon = mealIcons[meal.meal_type] || 'ğŸ½ï¸';
                const date = new Date(meal.created_at).toLocaleDateString('zh-CN', {
                    month: 'numeric',
                    day: 'numeric'
                });
                
                // è§£æé£Ÿç‰©åˆ—è¡¨
                let foods = [];
                try {
                    foods = typeof meal.foods === 'string' ? JSON.parse(meal.foods) : (meal.foods || []);
                } catch(e) {
                    foods = [];
                }
                
                const foodsText = foods.map(f => f.name).join('ã€') || 'æ— è¯¦æƒ…';
                
                return `
                    <div class="meal-record-item">
                        <div class="meal-header">
                            <span class="meal-icon">${icon}</span>
                            <span class="meal-type">${meal.meal_type}</span>
                            <span class="meal-date">${date}</span>
                            <span class="meal-calories">${meal.total_calories} å¡</span>
                        </div>
                        <div class="meal-foods">${escapeHtml(foodsText)}</div>
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½èŠå¤©è®°å½•
        async function loadChatHistory(friendId) {
            try {
                const response = await fetch(`/api/messages?friend_id=${friendId}`);
                if (response.ok) {
                    const messages = await response.json();
                    renderChatHistory(messages);
                }
            } catch (error) {
                console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“èŠå¤©è®°å½•
        function renderChatHistory(messages) {
            const container = document.getElementById('chatHistory');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-tip">æš‚æ— ç•™è¨€</div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const isFromMe = msg.sender_id === currentUserId;
                const time = new Date(msg.created_at).toLocaleString('zh-CN', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric'
                });
                
                return `
                    <div class="chat-message ${isFromMe ? 'sent' : 'received'}">
                        <div class="chat-sender">${isFromMe ? 'æˆ‘' : msg.sender_name}</div>
                        <div class="chat-bubble">${escapeHtml(msg.content)}</div>
                        <div class="chat-time">${time}</div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        // å‘é€ç•™è¨€
        async function sendMessage() {
            if (!currentFriendId) return;
            
            const input = document.getElementById('messageContent');
            const content = input.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }
            
            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        receiver_id: currentFriendId,
                        content: content
                    })
                });
                
                if (response.ok) {
                    input.value = '';
                    await loadChatHistory(currentFriendId);
                } else {
                    alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('å‘é€ç•™è¨€å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('friendDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'friendDetailModal') {
                closeFriendDetail();
            }
        });

        // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ‰“å¼€å¥½å‹è¯¦æƒ…
        async function checkAutoOpenFriend() {
            const openFriendId = sessionStorage.getItem('openFriendId');
            if (openFriendId) {
                sessionStorage.removeItem('openFriendId');
                // ç­‰å¾…å¥½å‹åˆ—è¡¨åŠ è½½å®Œæˆ
                await loadFriends();
                // æŸ¥æ‰¾å¥½å‹ä¿¡æ¯
                const response = await fetch('/api/friends');
                if (response.ok) {
                    const friends = await response.json();
                    const friend = friends.find(f => f.id === parseInt(openFriendId));
                    if (friend) {
                        openFriendDetail(friend.id, friend.username, friend.goal || '');
                    }
                }
            }
        }

        // åˆå§‹åŒ–
        loadCurrentUser();
        loadFriends().then(() => {
            checkAutoOpenFriend();
        });
    </script>
</body>
</html>
